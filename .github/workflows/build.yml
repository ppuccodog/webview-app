name: å®‰å“å¥—å£³åº”ç”¨æ„å»º+è‡ªåŠ¨å‘ç‰ˆï¼ˆç¡®ä¿APKå‘å¸ƒï¼‰
on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ï¼Œä¾¿äºæµ‹è¯•

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      ##########################################################################
      # æ­¥éª¤1ï¼šæ‹‰å–ä»£ç ï¼ˆå¿…é¡»å¸¦å®Œæ•´å†å²ï¼Œå¦åˆ™Tagæ¨é€å¤±è´¥ï¼‰
      ##########################################################################
      - name: æ‹‰å–ä»£ç ï¼ˆå«å®Œæ•´Gitå†å²ï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…³é”®ï¼šæ‹‰å–æ‰€æœ‰æäº¤å†å²ï¼Œæ”¯æŒTagæ“ä½œ
          persist-credentials: true  # ä¿ç•™å‡­è¯ï¼Œå…è®¸æ¨é€Tag

      ##########################################################################
      # æ­¥éª¤2ï¼šå®‰è£…å®‰å“æ„å»ºä¾èµ–ï¼ˆJDK/SDK/Gradleï¼Œç¡®ä¿ç¯å¢ƒå®Œæ•´ï¼‰
      ##########################################################################
      - name: å®‰è£…å®‰å“æ„å»ºä¾èµ–
        run: |
          export TIMEOUT=300
          
          # å®‰è£…JDK 11
          sudo apt-get update -o Acquire::ForceIPv4=true
          sudo apt-get install -y -qq openjdk-11-jdk
          echo "JDK11_PATH=/usr/lib/jvm/java-11-openjdk-amd64" >> $GITHUB_ENV

          # é…ç½®Android SDK
          ANDROID_SDK_PATH="$HOME/android-sdk"
          mkdir -p "$ANDROID_SDK_PATH"
          echo "ANDROID_HOME=$ANDROID_SDK_PATH" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_PATH" >> $GITHUB_ENV

          # ä¸‹è½½SDK Toolsï¼ˆæ¸…åé•œåƒï¼Œé¿å…è¶…æ—¶ï¼‰
          SDK_TOOLS_URL="https://mirrors.tuna.tsinghua.edu.cn/android/repository/commandlinetools-linux-9477386_latest.zip"
          wget --timeout=$TIMEOUT --tries=3 "$SDK_TOOLS_URL" -O sdk-tools.zip || {
            wget --timeout=$TIMEOUT --tries=2 "https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip" -O sdk-tools.zip || exit 1
          }
          mkdir -p "$ANDROID_SDK_PATH/cmdline-tools/latest"
          unzip -q sdk-tools.zip -d "$ANDROID_SDK_PATH/cmdline-tools/latest"
          mv "$ANDROID_SDK_PATH/cmdline-tools/latest/cmdline-tools/"* "$ANDROID_SDK_PATH/cmdline-tools/latest/"
          rm -rf "$ANDROID_SDK_PATH/cmdline-tools/latest/cmdline-tools"

          # æ¥å—SDKè®¸å¯è¯
          SDK_MANAGER="$ANDROID_SDK_PATH/cmdline-tools/latest/bin/sdkmanager"
          chmod +x "$SDK_MANAGER"
          yes | "$SDK_MANAGER" --sdk_root="$ANDROID_SDK_PATH" --licenses || true

          # å®‰è£…SDKæ ¸å¿ƒç»„ä»¶ï¼ˆandroid-30+30.0.2æ„å»ºå·¥å…·ï¼‰
          "$SDK_MANAGER" --sdk_root="$ANDROID_SDK_PATH" \
            "platforms;android-30" "build-tools;30.0.2" "platform-tools" \
            --verbose --no_https || exit 1

          # å®‰è£…Gradle 7.0.2ï¼ˆæœ¬åœ°å®‰è£…ï¼Œé¿å…åœ¨çº¿ä¸‹è½½è¶…æ—¶ï¼‰
          GRADLE_PATH="$HOME/gradle-7.0.2"
          if [ ! -d "$GRADLE_PATH" ]; then
            wget --timeout=$TIMEOUT --tries=3 "https://mirrors.huaweicloud.com/gradle/gradle-7.0.2-bin.zip" -O gradle.zip || exit 1
            unzip -q gradle.zip -d "$HOME"
          fi
          echo "GRADLE_PATH=$GRADLE_PATH" >> $GITHUB_ENV
          echo "$GRADLE_PATH/bin" >> $GITHUB_PATH

      ##########################################################################
      # æ­¥éª¤3ï¼šæ„å»ºAPKï¼ˆæ ¸å¿ƒæ­¥éª¤ï¼Œç¡®ä¿APKç”Ÿæˆå¹¶è¾“å‡ºåˆ°æŒ‡å®šè·¯å¾„ï¼‰
      ##########################################################################
      - name: æ„å»ºå®‰å“å¥—å£³åº”ç”¨ï¼ˆç¡®ä¿APKç”Ÿæˆï¼‰
        run: |
          # åŠ è½½ç¯å¢ƒå˜é‡
          export JAVA_HOME="${{ env.JDK11_PATH }}"
          export ANDROID_HOME="${{ env.ANDROID_HOME }}"
          export GRADLE_PATH="${{ env.GRADLE_PATH }}"
          export PATH="$JAVA_HOME/bin:$ANDROID_HOME/build-tools/30.0.2:$GRADLE_PATH/bin:$PATH"

          # 1. åˆ›å»ºé¡¹ç›®ç›®å½•ï¼ˆé€å±‚åˆ›å»ºï¼Œé¿å…è·¯å¾„é”™è¯¯ï¼‰
          PROJECT_PATH="/home/runner/work/webview-app/webview-app/myapp"
          ANDROID_ROOT="$PROJECT_PATH/android-project"
          APP_DIR="$ANDROID_ROOT/app"
          WWW_DIR="$PROJECT_PATH/www"
          
          rm -rf "$PROJECT_PATH"  # æ¸…ç†æ—§æ„å»º
          mkdir -p "$WWW_DIR" \
                   "$APP_DIR/src/main/java/com/my/simpleapp" \
                   "$APP_DIR/src/main/res/values" \
                   "$ANDROID_ROOT/CordovaLib/src/main/java/org/apache/cordova"

          # 2. ç¼–å†™WebViewé¡µé¢ï¼ˆå¥—å£³æ ¸å¿ƒï¼‰
          cat > "$WWW_DIR/index.html" << EOF
          <!DOCTYPE html>
          <html>
          <head><meta charset="UTF-8"><title>å¥—å£³åº”ç”¨</title></head>
          <body><h1>æ„å»ºæˆåŠŸï¼</h1></body>
          </html>
          EOF

          # 3. ç¼–å†™æ ¸å¿ƒJavaä»£ç ï¼ˆCordovaActivity+MainActivityï¼‰
          cat > "$ANDROID_ROOT/CordovaLib/src/main/java/org/apache/cordova/CordovaActivity.java" << EOF
          package org.apache.cordova;
          import android.app.Activity;
          import android.os.Bundle;
          import android.webkit.WebView;
          public class CordovaActivity extends Activity {
              protected WebView webView;
              @Override
              public void onCreate(Bundle s) {
                  super.onCreate(s);
                  webView = new WebView(this);
                  webView.loadUrl("file:///android_asset/www/index.html");
                  setContentView(webView);
              }
          }
          EOF

          cat > "$APP_DIR/src/main/java/com/my/simpleapp/MainActivity.java" << EOF
          package com.my.simpleapp;
          import org.apache.cordova.CordovaActivity;
          import android.os.Bundle;
          public class MainActivity extends CordovaActivity {}
          EOF

          # 4. ç¼–å†™Androidé…ç½®æ–‡ä»¶ï¼ˆç¡®ä¿èƒ½ç¼–è¯‘é€šè¿‡ï¼‰
          cat > "$APP_DIR/src/main/AndroidManifest.xml" << EOF
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android" package="com.my.simpleapp">
              <uses-permission android:name="android.permission.INTERNET"/>
              <application android:label="@string/app_name">
                  <activity android:name=".MainActivity">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN"/>
                          <category android:name="android.intent.category.LAUNCHER"/>
                      </intent-filter>
                  </activity>
              </application>
          </manifest>
          EOF

          cat > "$APP_DIR/src/main/res/values/strings.xml" << EOF
          <resources><string name="app_name">YJSCSDH</string></resources>
          EOF

          # 5. ç¼–å†™Gradleé…ç½®ï¼ˆå¼ºåˆ¶ç”Ÿæˆrelease APKï¼‰
          cat > "$ANDROID_ROOT/settings.gradle" << EOF
          include ':app', ':CordovaLib'
          EOF

          cat > "$ANDROID_ROOT/CordovaLib/build.gradle" << 'EOF'
          apply plugin: 'com.android.library'
          android { compileSdk 30; namespace 'org.apache.cordova' }
          dependencies { implementation 'androidx.appcompat:appcompat:1.0.2' }
          EOF

          cat > "$APP_DIR/build.gradle" << 'EOF'
          apply plugin: 'com.android.application'
          android {
              compileSdk 30; namespace 'com.my.simpleapp'
              defaultConfig { applicationId "com.my.simpleapp"; minSdk 21; targetSdk 30 }
              buildTypes {
                  release {
                      minifyEnabled false
                      signingConfig signingConfigs.debug  # å¼ºåˆ¶ç”¨è°ƒè¯•ç­¾åï¼Œç¡®ä¿ç”ŸæˆAPK
                  }
              }
              lintOptions { abortOnError false }  # å¿½ç•¥linté”™è¯¯
          }
          dependencies { implementation project(':CordovaLib'); implementation 'androidx.appcompat:appcompat:1.0.2' }
          EOF

          # 6. ç¼–è¯‘APKï¼ˆæ¸…ç†+æ„å»ºï¼Œè¾“å‡ºè¯¦ç»†æ—¥å¿—ï¼‰
          cd "$ANDROID_ROOT" || exit 1
          gradle wrapper --gradle-version 7.0.2
          chmod +x gradlew
          echo "=== å¼€å§‹ç¼–è¯‘Release APK ==="
          ./gradlew clean :app:assembleRelease --info  # --infoè¾“å‡ºè¯¦ç»†æ—¥å¿—ï¼Œä¾¿äºæ’æŸ¥

          # 7. å¼ºåˆ¶å¤åˆ¶APKåˆ°å›ºå®šè·¯å¾„ï¼ˆé¿å…è·¯å¾„æ‰¾ä¸åˆ°ï¼‰
          APK_SOURCE="$APP_DIR/build/outputs/apk/release"
          APK_DEST="/home/runner/work/webview-app/webview-app/YJSCSDH-v1.0.0.apk"  # ç®€åŒ–è·¯å¾„ï¼Œé¿å…åµŒå¥—è¿‡æ·±
          
          # æ£€æŸ¥æ‰€æœ‰å¯èƒ½çš„APKæ–‡ä»¶ï¼ˆæœ‰ç­¾å/æ— ç­¾åï¼‰
          if ls "$APK_SOURCE"/*.apk 1> /dev/null 2>&1; then
            cp "$APK_SOURCE"/*.apk "$APK_DEST"
            echo "âœ… APKå¤åˆ¶æˆåŠŸï¼ç›®æ ‡è·¯å¾„ï¼š$APK_DEST"
            echo "APKå¤§å°ï¼š$(du -sh "$APK_DEST")"  # éªŒè¯æ–‡ä»¶å­˜åœ¨ä¸”éç©º
          else
            echo "âŒ æœªæ‰¾åˆ°APKæ–‡ä»¶ï¼æ„å»ºè¾“å‡ºç›®å½•ç»“æ„ï¼š"
            ls -R "$APP_DIR/build/outputs"  # è¾“å‡ºç»“æ„ï¼Œå¸®åŠ©æ’æŸ¥
            exit 1
          fi

      ##########################################################################
      # æ­¥éª¤4ï¼šåˆ›å»ºå¹¶æ¨é€Git Tagï¼ˆç¡®ä¿Releasesæœ‰ç»‘å®šçš„Tagï¼‰
      ##########################################################################
      - name: åˆ›å»ºå¹¶æ¨é€Git Tag
        run: |
          # é…ç½®Gitç”¨æˆ·ï¼ˆå¿…é¡»ï¼Œå¦åˆ™æ¨é€å¤±è´¥ï¼‰
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          TAG_NAME="v1.0.0"  # å›ºå®šTagåï¼Œä¾¿äºæµ‹è¯•ï¼›åç»­å¯æ”¹ä¸ºåŠ¨æ€ç‰ˆæœ¬
          
          # æ¸…ç†æ—§Tagï¼ˆé¿å…å†²çªï¼‰
          if git rev-parse --verify --quiet "$TAG_NAME"; then
            git tag -d "$TAG_NAME"
            git push origin --delete "$TAG_NAME"
            echo "å·²åˆ é™¤æ—§Tagï¼š$TAG_NAME"
          fi
          
          # åˆ›å»ºæ–°Tagå¹¶æ¨é€
          git tag -a "$TAG_NAME" -m "YJSCSDHåº”ç”¨v1.0.0ç‰ˆæœ¬"
          git push origin "$TAG_NAME" || {
            echo "âŒ Tagæ¨é€å¤±è´¥ï¼Œé‡è¯•ä¸€æ¬¡ï¼ˆå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜ï¼‰"
            git push origin "$TAG_NAME" || exit 1
          }
          echo "âœ… Tagæ¨é€æˆåŠŸï¼Tagåç§°ï¼š$TAG_NAME"

      ##########################################################################
      # æ­¥éª¤5ï¼šå‘å¸ƒåˆ°GitHub Releasesï¼ˆå…³è”Tag+å›ºå®šAPKè·¯å¾„ï¼‰
      ##########################################################################
      - name: å‘å¸ƒAPKåˆ°GitHub Releases
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # æ— éœ€æ‰‹åŠ¨é…ç½®ï¼ŒGitHubè‡ªåŠ¨æä¾›
        with:
          tag_name: "v1.0.0"  # å¿…é¡»ä¸æ­¥éª¤4çš„Tagåä¸€è‡´
          name: "YJSCSDHåº”ç”¨v1.0.0"  # Releasesæ˜¾ç¤ºçš„åç§°
          body: |
            ğŸ“± å®‰å“å¥—å£³åº”ç”¨è‡ªåŠ¨æ„å»ºç‰ˆæœ¬
            - æ„å»ºæ—¶é—´ï¼š${{ github.run_at }}
            - æ”¯æŒç³»ç»Ÿï¼šAndroid 5.0+ï¼ˆAPI 21+ï¼‰
            - åº”ç”¨åŒ…åï¼šcom.my.simpleapp
          files: /home/runner/work/webview-app/webview-app/YJSCSDH-v1.0.0.apk  # ä¸æ­¥éª¤3çš„APK_DESTä¸€è‡´
          draft: false  # ä¸è®¾ä¸ºè‰ç¨¿ï¼Œå‘å¸ƒåç›´æ¥å¯è§
          prerelease: false  # è®¾ä¸ºæ­£å¼ç‰ˆæœ¬
