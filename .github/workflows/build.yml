name: æ„å»ºå®‰å“åº”ç”¨ï¼ˆç›®å½•éªŒè¯ç‰ˆï¼‰
on:
  workflow_dispatch:

jobs:
  build-android-apk:
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£…Node.js 14
        uses: actions/setup-node@v4
        with:
          node-version: 14

      - name: å®‰è£…Cordovaç¯å¢ƒ
        run: |
          npm config set registry https://registry.npmjs.org/
          npm cache clean --force
          npm install -g cordova@10.0.0 cordova-android@9.0.0
          cordova -v
          node -v
          npm -v

      - name: å®‰è£…å®‰å“æ„å»ºå·¥å…·é“¾
        run: |
          # å®‰è£…JDK8
          sudo apt-get update
          sudo apt-get install -y openjdk-8-jdk
          JDK8_PATH="/usr/lib/jvm/java-8-openjdk-amd64"
          echo "JDK8_PATH=$JDK8_PATH" >> $GITHUB_ENV

          # å®‰è£…å®‰å“SDK
          ANDROID_SDK_PATH="$HOME/android-sdk"
          mkdir -p $ANDROID_SDK_PATH
          wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O sdk-tools.zip
          unzip -q sdk-tools.zip -d $ANDROID_SDK_PATH/cmdline-tools
          SDK_MANAGER="$ANDROID_SDK_PATH/cmdline-tools/cmdline-tools/bin/sdkmanager"
          yes | $SDK_MANAGER --licenses || true
          $SDK_MANAGER "platforms;android-29" "build-tools;29.0.3" "platform-tools"
          echo "ANDROID_SDK_PATH=$ANDROID_SDK_PATH" >> $GITHUB_ENV

          # å®‰è£…Gradle 6.5
          GRADLE_PATH="$HOME/gradle-6.5"
          wget https://services.gradle.org/distributions/gradle-6.5-bin.zip -O gradle-6.5-bin.zip
          unzip -q gradle-6.5-bin.zip -d $HOME
          echo "GRADLE_PATH=$GRADLE_PATH" >> $GITHUB_ENV
          echo "$GRADLE_PATH/bin" >> $GITHUB_PATH

      - name: åˆå§‹åŒ–Cordovaé¡¹ç›®å¹¶ç¼–è¯‘APK
        run: |
          # åŠ è½½ç¯å¢ƒå˜é‡
          export JAVA_HOME=$JDK8_PATH
          export PATH="$JAVA_HOME/bin:$PATH:$ANDROID_SDK_PATH/build-tools/29.0.3:$GRADLE_PATH/bin"
          export ANDROID_SDK_ROOT=$ANDROID_SDK_PATH
          export ANDROID_HOME=$ANDROID_SDK_PATH

          # é¡¹ç›®è·¯å¾„
          PROJECT_PATH="/home/runner/work/webview-app/webview-app/myapp"
          rm -rf "$PROJECT_PATH"
          mkdir -p "$PROJECT_PATH"
          cd "$PROJECT_PATH" || exit 1

          # 1. åˆ›å»ºCordovaé¡¹ç›®
          echo "åˆ›å»ºCordovaé¡¹ç›®..."
          cordova create . com.my.simpleapp YJSCSDH
          ls -la  # æŸ¥çœ‹é¡¹ç›®åˆå§‹ç»“æ„

          # 2. æ¸…ç†å¹¶æ·»åŠ å®‰å“å¹³å°ï¼ˆåˆ†æ­¥æ‰§è¡Œ+éªŒè¯ï¼‰
          echo "ç§»é™¤æ—§å¹³å°ï¼ˆå¦‚æœ‰ï¼‰..."
          cordova platform rm android --nosave || true
          rm -rf platforms/android node_modules/cordova-android

          echo "å®‰è£…cordova-androidä¾èµ–..."
          npm install cordova-android@9.0.0 --save-exact
          ls -la node_modules  # éªŒè¯ä¾èµ–å®‰è£…

          echo "æ·»åŠ å®‰å“å¹³å°..."
          cordova platform add android@9.0.0 --save
          
          # å…³é”®ï¼šéªŒè¯å¹³å°ç›®å½•æ˜¯å¦å­˜åœ¨
          ANDROID_PLATFORM_DIR="$PROJECT_PATH/platforms/android"
          if [ ! -d "$ANDROID_PLATFORM_DIR" ]; then
            echo "âŒ å®‰å“å¹³å°ç›®å½•åˆ›å»ºå¤±è´¥ï¼å½“å‰å¹³å°ç›®å½•ç»“æ„ï¼š"
            ls -la platforms
            exit 1
          fi
          echo "âœ… å®‰å“å¹³å°ç›®å½•å·²æˆåŠŸåˆ›å»º"

          # 3. ç”Ÿæˆgradlew
          echo "è¿›å…¥å®‰å“å¹³å°ç›®å½•å¹¶ç”Ÿæˆgradlew..."
          cd "$ANDROID_PLATFORM_DIR" || {
            echo "âŒ æ— æ³•è¿›å…¥å®‰å“å¹³å°ç›®å½•: $ANDROID_PLATFORM_DIR"
            exit 1
          }
          gradle wrapper --gradle-version 6.5
          chmod +x gradlew
          [ -f "gradlew" ] || { echo "âŒ gradlewç”Ÿæˆå¤±è´¥"; exit 1; }

          # 4. ç¦ç”¨AndroidX
          echo "é…ç½®gradle.propertiesç¦ç”¨AndroidX..."
          echo "android.useAndroidX=false" > gradle.properties
          echo "android.enableJetifier=false" >> gradle.properties
          cat gradle.properties  # éªŒè¯é…ç½®

          # 5. ç¼–è¯‘APK
          echo "å¼€å§‹ç¼–è¯‘APK..."
          ./gradlew :app:assembleRelease --info

          # 6. éªŒè¯å¹¶å¤åˆ¶APK
          APK_SOURCE="app/build/outputs/apk/release/app-release.apk"
          APK_DEST="../../final-app.apk"
          if [ -f "$APK_SOURCE" ]; then
            echo "ğŸ‰ APKç¼–è¯‘æˆåŠŸï¼"
            cp "$APK_SOURCE" "$APK_DEST"
          else
            echo "âŒ APKä¸å­˜åœ¨ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š"
            cat build/outputs/logs/build.log
            exit 1
          fi

      - name: ä¸Šä¼ APKå·¥ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: å®‰å“åº”ç”¨-Releaseç‰ˆ
          path: /home/runner/work/webview-app/webview-app/myapp/final-app.apk
          retention-days: 30
