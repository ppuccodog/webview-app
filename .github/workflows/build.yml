name: æ„å»ºå®‰å“åº”ç”¨ï¼ˆç»ˆæå¯è¿è¡Œç‰ˆï¼‰
on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ

jobs:
  build-android-apk:
    runs-on: ubuntu-latest  # ä½¿ç”¨æœ€æ–°ç‰ˆ Ubuntu è¿è¡Œç¯å¢ƒ
    steps:
      # æ­¥éª¤1ï¼šæ‹‰å–ä»£ç ä»“åº“
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      # æ­¥éª¤2ï¼šå®‰è£… Node.js 14ï¼ˆåŒ¹é… Cordova 10.0.0 å…¼å®¹ç‰ˆæœ¬ï¼‰
      - name: å®‰è£… Node.js 14
        uses: actions/setup-node@v4
        with:
          node-version: 14
          cache: 'npm'  # ç¼“å­˜ npm ä¾èµ–ï¼ŒåŠ é€Ÿåç»­å®‰è£…

      # æ­¥éª¤3ï¼šå…¨å±€å®‰è£… Cordova åŠä¾èµ–
      - name: å®‰è£… Cordova ç¯å¢ƒ
        run: |
          # é…ç½® npm é•œåƒï¼ŒåŠ é€Ÿå®‰è£…
          npm config set registry https://registry.npmjs.org/
          # æ¸…ç†ç¼“å­˜ï¼Œé¿å…æ—§ä¾èµ–å†²çª
          npm cache clean --force
          # å®‰è£…æŒ‡å®šç‰ˆæœ¬ Cordovaï¼ˆ10.0.0ï¼‰å’Œ cordova-androidï¼ˆ9.0.0ï¼‰
          npm install -g cordova@10.0.0 cordova-android@9.0.0
          # éªŒè¯å®‰è£…ç»“æœ
          cordova -v
          node -v
          npm -v

      # æ­¥éª¤4ï¼šå®‰è£… JDK8ã€å®‰å“ SDKã€Gradleï¼ˆæ„å»ºå®‰å“å¿…éœ€å·¥å…·é“¾ï¼‰
      - name: å®‰è£…å®‰å“æ„å»ºå·¥å…·é“¾
        run: |
          # 1. å®‰è£… JDK8ï¼ˆå®‰å“æ„å»ºå¼ºåˆ¶è¦æ±‚ï¼‰
          sudo apt-get update
          sudo apt-get install -y openjdk-8-jdk
          JDK8_PATH="/usr/lib/jvm/java-8-openjdk-amd64"
          echo "JDK8_PATH=$JDK8_PATH" >> $GITHUB_ENV  # ä¿å­˜è·¯å¾„åˆ°ç¯å¢ƒå˜é‡

          # 2. å®‰è£…å®‰å“ SDKï¼ˆæŒ‡å®š API 29 ç‰ˆæœ¬ï¼ŒåŒ¹é… cordova-android@9.0.0ï¼‰
          ANDROID_SDK_PATH="$HOME/android-sdk"
          mkdir -p $ANDROID_SDK_PATH
          # ä¸‹è½½ SDK å‘½ä»¤è¡Œå·¥å…·
          wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O sdk-tools.zip
          unzip -q sdk-tools.zip -d $ANDROID_SDK_PATH/cmdline-tools
          # æ¥å— SDK è®¸å¯åè®®
          SDK_MANAGER="$ANDROID_SDK_PATH/cmdline-tools/cmdline-tools/bin/sdkmanager"
          yes | $SDK_MANAGER --licenses || true
          # å®‰è£…å¿…éœ€çš„ SDK ç»„ä»¶
          $SDK_MANAGER "platforms;android-29" "build-tools;29.0.3" "platform-tools"
          echo "ANDROID_SDK_PATH=$ANDROID_SDK_PATH" >> $GITHUB_ENV  # ä¿å­˜è·¯å¾„

          # 3. å®‰è£… Gradle 6.5ï¼ˆä¸ cordova-android@9.0.0 å®Œå…¨å…¼å®¹ï¼‰
          GRADLE_PATH="$HOME/gradle-6.5"
          wget https://services.gradle.org/distributions/gradle-6.5-bin.zip -O gradle-6.5-bin.zip
          unzip -q gradle-6.5-bin.zip -d $HOME
          echo "GRADLE_PATH=$GRADLE_PATH" >> $GITHUB_ENV  # ä¿å­˜è·¯å¾„
          echo "$GRADLE_PATH/bin" >> $GITHUB_PATH  # æ·»åŠ åˆ°ç³»ç»Ÿ PATH

      # æ­¥éª¤5ï¼šåˆå§‹åŒ– Cordova é¡¹ç›®å¹¶æ„å»º APK
      - name: åˆå§‹åŒ–é¡¹ç›®å¹¶ç¼–è¯‘ APK
        run: |
          # åŠ è½½ä¹‹å‰ä¿å­˜çš„ç¯å¢ƒå˜é‡
          export JAVA_HOME=$JDK8_PATH
          export PATH="$JAVA_HOME/bin:$PATH:$ANDROID_SDK_PATH/build-tools/29.0.3:$GRADLE_PATH/bin"
          export ANDROID_SDK_ROOT=$ANDROID_SDK_PATH  # å®‰å“ SDK æ ¹ç›®å½•
          export ANDROID_HOME=$ANDROID_SDK_PATH  # å…¼å®¹æ—§ç‰ˆå·¥å…·çš„ç¯å¢ƒå˜é‡

          # é¡¹ç›®åŸºç¡€è·¯å¾„ï¼ˆä¸ä»£ç ä»“åº“è·¯å¾„å¯¹åº”ï¼‰
          PROJECT_PATH="/home/runner/work/webview-app/webview-app/myapp"
          # å½»åº•æ¸…ç†æ—§é¡¹ç›®æ®‹ç•™ï¼ˆé¿å…å¹³å°é‡å¤æ·»åŠ é—®é¢˜ï¼‰
          rm -rf "$PROJECT_PATH"
          mkdir -p "$PROJECT_PATH"
          cd "$PROJECT_PATH"

          # 1. ç”¨ Cordova å®˜æ–¹å‘½ä»¤åˆå§‹åŒ–é¡¹ç›®ï¼ˆé¿å…æ‰‹åŠ¨é…ç½®é”™è¯¯ï¼‰
          # æ ¼å¼ï¼šcordova create é¡¹ç›®ç›®å½• åº”ç”¨åŒ…å åº”ç”¨åç§°
          cordova create . com.my.simpleapp YJSCSDH
          
          # 2. å¼ºåˆ¶æ¸…ç†å¹¶æ·»åŠ å®‰å“å¹³å°ï¼ˆè§£å†³â€œPlatform already addedâ€é”™è¯¯ï¼‰
          # å…ˆç§»é™¤å·²å­˜åœ¨çš„å®‰å“å¹³å°ï¼ˆå³ä½¿ä¸å­˜åœ¨ä¹Ÿä¸æŠ¥é”™ï¼‰
          cordova platform rm android --nosave || true
          # å½»åº•åˆ é™¤å¹³å°æ®‹ç•™ç›®å½•å’Œä¾èµ–
          rm -rf platforms/android node_modules/cordova-android package-lock.json
          # é‡æ–°å®‰è£…ç²¾ç¡®ç‰ˆæœ¬çš„ cordova-android ä¾èµ–
          npm install cordova-android@9.0.0 --save-exact
          # é‡æ–°æ·»åŠ å®‰å“å¹³å°ï¼ˆç¡®ä¿çŠ¶æ€å¹²å‡€ï¼‰
          cordova platform add android@9.0.0 --save

          # 3. ç”Ÿæˆ gradlew å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆè§£å†³â€œgradlew ä¸å­˜åœ¨â€é—®é¢˜ï¼‰
          cd platforms/android
          gradle wrapper --gradle-version 6.5 --distribution-type all
          chmod +x gradlew  # èµ‹äºˆæ‰§è¡Œæƒé™
          [ -f "gradlew" ] || { echo "âŒ gradlew ç”Ÿæˆå¤±è´¥"; exit 1; }

          # 4. ç¦ç”¨ AndroidXï¼ˆè§£å†³é…ç½®å†²çªè­¦å‘Šï¼‰
          echo "android.useAndroidX=false" > gradle.properties
          echo "android.enableJetifier=false" >> gradle.properties

          # 5. ç¼–è¯‘ Release ç‰ˆæœ¬ APKï¼ˆæŒ‡å®š app æ¨¡å—ï¼Œè§£å†³ä»»åŠ¡ä¸å­˜åœ¨é—®é¢˜ï¼‰
          echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘ APK..."
          ./gradlew :app:assembleRelease --quiet  # --quiet å‡å°‘æ—¥å¿—è¾“å‡º

          # 6. éªŒè¯ APK å¹¶å¤åˆ¶åˆ°æŒ‡å®šè·¯å¾„ï¼ˆä¾¿äºåç»­ä¸Šä¼ ï¼‰
          APK_SOURCE="$PROJECT_PATH/platforms/android/app/build/outputs/apk/release/app-release.apk"
          APK_DEST="$PROJECT_PATH/final-app.apk"
          if [ -f "$APK_SOURCE" ]; then
            echo "ğŸ‰ APK ç¼–è¯‘æˆåŠŸï¼"
            cp "$APK_SOURCE" "$APK_DEST"
          else
            echo "âŒ APK ç¼–è¯‘å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š"
            cat "$PROJECT_PATH/platforms/android/build/outputs/logs/build.log"
            exit 1
          fi

      # æ­¥éª¤6ï¼šä¸Šä¼ ç¼–è¯‘å¥½çš„ APK ä½œä¸ºå·¥ä»¶
      - name: ä¸Šä¼  APK å·¥ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: å®‰å“å¥—å£³åº”ç”¨-Release ç‰ˆ
          path: /home/runner/work/webview-app/webview-app/myapp/final-app.apk
          retention-days: 30  # å·¥ä»¶ä¿ç•™ 30 å¤©
