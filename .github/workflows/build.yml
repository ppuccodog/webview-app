name: æ„å»ºå®‰å“åº”ç”¨ï¼ˆå®˜æ–¹ç¯å¢ƒæ–¹æ¡ˆï¼‰
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-20.04  # ä½¿ç”¨æ›´ç¨³å®šçš„æ—§ç‰ˆæœ¬ç³»ç»Ÿ
    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£…Node.js 14
        uses: actions/setup-node@v4
        with:
          node-version: 14

      - name: å®‰è£…Cordovaå’Œä¾èµ–
        run: |
          npm config set registry https://registry.npmjs.org/
          npm install -g cordova@10.0.0
          npm install -g properties-parser@0.6.0 string.prototype.codepointat@1.0.1

      - name: å®‰è£…Java 8
        uses: actions/setup-java@v3
        with:
          java-version: '8'
          distribution: 'temurin'

      - name: å®‰è£…å®‰å“ç¯å¢ƒï¼ˆç”¨å®˜æ–¹è„šæœ¬è‡ªåŠ¨é…ç½®ï¼‰
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r21e
          add-to-path: false
          api-level: 29
          build-tools-version: 29.0.3

      - name: åˆ›å»ºå¹¶ç¼–è¯‘é¡¹ç›®
        run: |
          # åˆ›å»ºé¡¹ç›®
          cordova create myapp com.my.simpleapp "æˆ‘çš„ç½‘é¡µAPP"
          cd myapp
          
          # æ¸…é™¤æ‰€æœ‰æ’ä»¶é…ç½®
          echo '<?xml version="1.0" encoding="utf-8"?>
          <widget id="com.my.simpleapp" version="1.0.0" xmlns="http://www.w3.org/ns/widgets" xmlns:cdv="http://cordova.apache.org/ns/1.0">
            <name>æˆ‘çš„ç½‘é¡µAPP</name>
            <content src="index.html" />
            <access origin="*" />
          </widget>' > config.xml
          
          # æ·»åŠ å®‰å“å¹³å°ï¼ˆä½¿ç”¨è‡ªåŠ¨é…ç½®çš„ç¯å¢ƒï¼‰
          cordova platform add android@9.0.0
          
          # å¤åˆ¶ç½‘é¡µæ–‡ä»¶
          cp -rf ../www/* www/
          cp ../config.txt www/
          
          # ç¼–è¯‘APK
          cordova build android --release
          
          # æ£€æŸ¥ç»“æœ
          if [ -f "platforms/android/app/build/outputs/apk/release/app-release-unsigned.apk" ]; then
            echo "ğŸ‰ APKç”ŸæˆæˆåŠŸï¼"
          else
            echo "âŒ ç¼–è¯‘å¤±è´¥"
            exit 1
          fi

      - name: ä¸Šä¼ APK
        uses: actions/upload-artifact@v4
        with:
          name: æˆ‘çš„å®‰å“åº”ç”¨
          path: myapp/platforms/android/app/build/outputs/apk/release/app-release-unsigned.apk
          retention-days: 30
