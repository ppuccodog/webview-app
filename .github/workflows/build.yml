name: å®‰å“è‡ªå®šä¹‰APPè‡ªåŠ¨æž„å»ºï¼ˆæ”¯æŒconfig.xml+å›¾æ ‡ï¼‰
on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘æž„å»ºï¼ˆä¹Ÿå¯æ”¹ä¸ºpushè‡ªåŠ¨è§¦å‘ï¼‰
permissions:
  contents: write     # å…è®¸å†™å…¥Releases

jobs:
  build-app:
    runs-on: ubuntu-latest
    steps:
      ########################################################################
      # æ­¥éª¤1ï¼šæ‹‰å–ä»£ç +å®‰è£…ä¾èµ–ï¼ˆè§£æžXML+å¤„ç†å›¾æ ‡ï¼‰
      ########################################################################
      - name: æ‹‰å–GitHubé¡¹ç›®ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: å®‰è£…ä¾èµ–å·¥å…·ï¼ˆxmlstarletè§£æžXMLï¼Œimagemagickå¤„ç†å›¾æ ‡ï¼‰
        run: |
          # å®‰è£…XMLè§£æžå·¥å…·ï¼ˆè¯»å–config.xmlï¼‰å’Œå›¾ç‰‡å¤„ç†å·¥å…·ï¼ˆç”Ÿæˆé»˜è®¤å›¾æ ‡ï¼‰
          sudo apt-get update -y
          sudo apt-get install -y xmlstarlet imagemagick openjdk-11-jdk
          
          # é…ç½®JDKçŽ¯å¢ƒ
          echo "JDK11_PATH=/usr/lib/jvm/java-11-openjdk-amd64" >> $GITHUB_ENV

          ########################################################################
          # æ­¥éª¤2ï¼šä¸‹è½½Android SDK+Gradleï¼ˆæž„å»ºå®‰å“çŽ¯å¢ƒï¼‰
          ########################################################################
          export TIMEOUT=300
          # 1. é…ç½®Android SDKè·¯å¾„
          ANDROID_SDK_PATH="$HOME/android-sdk"
          mkdir -p "$ANDROID_SDK_PATH"
          echo "ANDROID_HOME=$ANDROID_SDK_PATH" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_PATH" >> $GITHUB_ENV

          # 2. ä¸‹è½½SDK Toolsï¼ˆä¼˜å…ˆé˜¿é‡Œäº‘é•œåƒï¼ŒåŠ é€Ÿä¸‹è½½ï¼‰
          SDK_TOOLS_URL="https://mirrors.aliyun.com/android/repository/commandlinetools-linux-9477386_latest.zip"
          if ! wget --timeout=$TIMEOUT --tries=3 "$SDK_TOOLS_URL" -O sdk-tools.zip; then
            SDK_TOOLS_URL="https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip"
            wget --timeout=$TIMEOUT --tries=2 "$SDK_TOOLS_URL" -O sdk-tools.zip || exit 1
          fi
          # è§£åŽ‹SDK Toolsåˆ°æŒ‡å®šç›®å½•
          mkdir -p "$ANDROID_SDK_PATH/cmdline-tools/latest"
          unzip -q sdk-tools.zip -d "$ANDROID_SDK_PATH/cmdline-tools/latest"
          mv "$ANDROID_SDK_PATH/cmdline-tools/latest/cmdline-tools/"* "$ANDROID_SDK_PATH/cmdline-tools/latest/" 2>/dev/null || true
          rm -rf "$ANDROID_SDK_PATH/cmdline-tools/latest/cmdline-tools"

          # 3. æŽ¥å—SDKè®¸å¯è¯+å®‰è£…å®‰å“æž„å»ºç»„ä»¶ï¼ˆAPI 30+æž„å»ºå·¥å…·ï¼‰
          SDK_MANAGER="$ANDROID_SDK_PATH/cmdline-tools/latest/bin/sdkmanager"
          chmod +x "$SDK_MANAGER"
          yes | "$SDK_MANAGER" --sdk_root="$ANDROID_SDK_PATH" --licenses || true
          "$SDK_MANAGER" --sdk_root="$ANDROID_SDK_PATH" \
            "platforms;android-30" \
            "build-tools;30.0.2" \
            "platform-tools" \
            "extras;android;m2repository" \
            --verbose --no_https || exit 1

          # 4. ä¸‹è½½Gradle 7.0.2ï¼ˆæž„å»ºå·¥å…·ï¼‰
          GRADLE_PATH="$HOME/gradle-7.0.2"
          if [ ! -d "$GRADLE_PATH" ]; then
            GRADLE_URL="https://mirrors.aliyun.com/gradle/gradle-7.0.2-bin.zip"
            if ! wget --timeout=$TIMEOUT --tries=3 "$GRADLE_URL" -O gradle.zip; then
              GRADLE_URL="https://services.gradle.org/distributions/gradle-7.0.2-bin.zip"
              wget --timeout=$TIMEOUT --tries=2 "$GRADLE_URL" -O gradle.zip || exit 1
            fi
            unzip -q gradle.zip -d "$HOME"
          fi
          echo "GRADLE_PATH=$GRADLE_PATH" >> $GITHUB_ENV
          echo "$GRADLE_PATH/bin" >> $GITHUB_PATH

      ########################################################################
      # æ­¥éª¤3ï¼šè§£æžconfig.xmlå’Œconfig.txté…ç½®ï¼ˆæ ¸å¿ƒï¼šè‡ªåŠ¨è¯»å–ç”¨æˆ·è‡ªå®šä¹‰ä¿¡æ¯ï¼‰
      ########################################################################
      - name: è§£æžé…ç½®æ–‡ä»¶ï¼ˆconfig.xml + config.txtï¼‰
        run: |
          # -------------------------- è§£æžconfig.xml --------------------------
          echo "ðŸ“ å¼€å§‹è§£æžconfig.xmlé…ç½®"
          # æ£€æŸ¥config.xmlæ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™ç”¨é»˜è®¤å€¼
          if [ ! -f "config.xml" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ°config.xmlï¼Œä½¿ç”¨é»˜è®¤é…ç½®"
            APP_PACKAGE="com.my.defaultapp"  # é»˜è®¤åŒ…å
            APP_NAME="é»˜è®¤åº”ç”¨"               # é»˜è®¤åº”ç”¨åç§°
            APP_VERSION="1.0.0"              # é»˜è®¤ç‰ˆæœ¬å·
            APP_DESCRIPTION="è‡ªå®šä¹‰ç½‘å€APP"  # é»˜è®¤æè¿°
            LOAD_TIMEOUT="60000"             # é»˜è®¤åŠ è½½è¶…æ—¶ï¼ˆ60ç§’ï¼‰
          else
            # ä»Žconfig.xmlè¯»å–é…ç½®ï¼ˆä½¿ç”¨xmlstarletå·¥å…·ï¼‰
            APP_PACKAGE=$(xmlstarlet sel -t -v "/widget/@id" config.xml)
            APP_NAME=$(xmlstarlet sel -t -v "/widget/name" config.xml)
            APP_VERSION=$(xmlstarlet sel -t -v "/widget/@version" config.xml)
            APP_DESCRIPTION=$(xmlstarlet sel -t -v "/widget/description" config.xml)
            LOAD_TIMEOUT=$(xmlstarlet sel -t -v "/widget/platform[@name='android']/preference[@name='LoadUrlTimeoutValue']/@value" config.xml)
            
            # è¡¥å…¨é»˜è®¤å€¼ï¼ˆé˜²æ­¢ç”¨æˆ·æœªé…ç½®æŸå­—æ®µï¼‰
            APP_PACKAGE=${APP_PACKAGE:-"com.my.defaultapp"}
            APP_NAME=${APP_NAME:-"é»˜è®¤åº”ç”¨"}
            APP_VERSION=${APP_VERSION:-"1.0.0"}
            APP_DESCRIPTION=${APP_DESCRIPTION:-"è‡ªå®šä¹‰ç½‘å€APP"}
            LOAD_TIMEOUT=${LOAD_TIMEOUT:-"60000"}
          fi

          # -------------------------- è§£æžconfig.txt --------------------------
          echo "ðŸŒ å¼€å§‹è§£æžconfig.txtç½‘å€"
          if [ -f "config.txt" ]; then
            CUSTOM_URL=$(cat config.txt)
            # å¤„ç†ç½‘å€æ ¼å¼ï¼ˆç¡®ä¿http/httpså‰ç¼€ï¼‰
            if [[ ! $CUSTOM_URL =~ ^http ]]; then
              CUSTOM_URL="https://$CUSTOM_URL"
              echo "âš ï¸ ç½‘å€ç¼ºå°‘http/httpså‰ç¼€ï¼Œè‡ªåŠ¨è¡¥å…¨ä¸ºï¼š$CUSTOM_URL"
            fi
          else
            CUSTOM_URL="https://www.baidu.com"
            echo "âš ï¸ æœªæ‰¾åˆ°config.txtï¼Œä½¿ç”¨é»˜è®¤ç½‘å€ï¼š$CUSTOM_URL"
          fi

          # -------------------------- è¾“å‡ºé…ç½®ä¿¡æ¯ --------------------------
          echo -e "\nâœ… æœ€ç»ˆé…ç½®ä¿¡æ¯ï¼š"
          echo "   - åº”ç”¨åŒ…åï¼š$APP_PACKAGE"
          echo "   - åº”ç”¨åç§°ï¼š$APP_NAME"
          echo "   - ç‰ˆæœ¬å·ï¼š$APP_VERSION"
          echo "   - æè¿°ï¼š$APP_DESCRIPTION"
          echo "   - åŠ è½½è¶…æ—¶ï¼š$LOAD_TIMEOUT ms"
          echo "   - ç›®æ ‡ç½‘å€ï¼š$CUSTOM_URL"

          # -------------------------- ä¿å­˜åˆ°çŽ¯å¢ƒå˜é‡ --------------------------
          echo "APP_PACKAGE=$APP_PACKAGE" >> $GITHUB_ENV
          echo "APP_NAME=$APP_NAME" >> $GITHUB_ENV
          echo "APP_VERSION=$APP_VERSION" >> $GITHUB_ENV
          echo "LOAD_TIMEOUT=$LOAD_TIMEOUT" >> $GITHUB_ENV
          echo "CUSTOM_URL=$CUSTOM_URL" >> $GITHUB_ENV

      ########################################################################
      # æ­¥éª¤4ï¼šå¤„ç†åº”ç”¨å›¾æ ‡ï¼ˆä»Žiconç›®å½•è¯»å–ï¼Œç¼ºå¤±åˆ™ç”Ÿæˆé»˜è®¤å›¾æ ‡ï¼‰
      ########################################################################
      - name: å¤„ç†åº”ç”¨å›¾æ ‡ï¼ˆè‡ªå®šä¹‰/é»˜è®¤ï¼‰
        run: |
          # åˆ›å»ºå®‰å“èµ„æºç›®å½•ï¼ˆå­˜æ”¾ä¸åŒåˆ†è¾¨çŽ‡å›¾æ ‡ï¼‰
          RES_DIR="/home/runner/work/webview-app/webview-app/myapp/android-project/app/src/main/res"
          mkdir -p "$RES_DIR/mipmap-mdpi" "$RES_DIR/mipmap-hdpi" "$RES_DIR/mipmap-xhdpi" "$RES_DIR/mipmap-xxhdpi" "$RES_DIR/mipmap-xxxhdpi"
          
          # å›¾æ ‡æ˜ å°„è¡¨ï¼ˆç”¨æˆ·å›¾æ ‡è·¯å¾„ â†’ å®‰å“å›¾æ ‡è·¯å¾„ + å°ºå¯¸ï¼‰
          declare -A ICON_MAP=(
            ["icon/icon-mdpi.png"]="$RES_DIR/mipmap-mdpi/ic_launcher.png:48x48"
            ["icon/icon-hdpi.png"]="$RES_DIR/mipmap-hdpi/ic_launcher.png:72x72"
            ["icon/icon-xhdpi.png"]="$RES_DIR/mipmap-xhdpi/ic_launcher.png:96x96"
            ["icon/icon-xxhdpi.png"]="$RES_DIR/mipmap-xxhdpi/ic_launcher.png:144x144"
            ["icon/icon-xxxhdpi.png"]="$RES_DIR/mipmap-xxxhdpi/ic_launcher.png:192x192"
          )

          # éåŽ†å›¾æ ‡æ˜ å°„è¡¨ï¼Œå¤åˆ¶è‡ªå®šä¹‰å›¾æ ‡æˆ–ç”Ÿæˆé»˜è®¤å›¾æ ‡
          for USER_ICON in "${!ICON_MAP[@]}"; do
            DEST_INFO=${ICON_MAP[$USER_ICON]}
            DEST_PATH=${DEST_INFO%%:*}  # å®‰å“å›¾æ ‡è·¯å¾„
            DEST_SIZE=${DEST_INFO#*:}   # å›¾æ ‡å°ºå¯¸
            if [ -f "$USER_ICON" ]; then
              # å­˜åœ¨è‡ªå®šä¹‰å›¾æ ‡ï¼šå¤åˆ¶å¹¶ç¼©æ”¾è‡³ç›®æ ‡å°ºå¯¸
              convert "$USER_ICON" -resize "$DEST_SIZE!" "$DEST_PATH"
              echo "âœ… å·²ä½¿ç”¨è‡ªå®šä¹‰å›¾æ ‡ï¼š$USER_ICON â†’ $DEST_PATHï¼ˆ$DEST_SIZEï¼‰"
            else
              # ä¸å­˜åœ¨è‡ªå®šä¹‰å›¾æ ‡ï¼šç”Ÿæˆè“è‰²é»˜è®¤å›¾æ ‡ï¼ˆä½¿ç”¨imagemagickï¼‰
              convert -size "$DEST_SIZE" xc:#2196F3 -fill white -font Arial -pointsize 16 -gravity center "APP" "$DEST_PATH"
              echo "âš ï¸ æœªæ‰¾åˆ°è‡ªå®šä¹‰å›¾æ ‡ï¼š$USER_ICONï¼Œç”Ÿæˆé»˜è®¤è“è‰²å›¾æ ‡ â†’ $DEST_PATHï¼ˆ$DEST_SIZEï¼‰"
            fi
          done

          # ä¿å­˜å›¾æ ‡é…ç½®åˆ°çŽ¯å¢ƒå˜é‡
          echo "RES_DIR=$RES_DIR" >> $GITHUB_ENV

      ########################################################################
      # æ­¥éª¤5ï¼šç”Ÿæˆå®‰å“é¡¹ç›®ä»£ç ï¼ˆä½¿ç”¨è§£æžçš„é…ç½®ï¼‰
      ########################################################################
      - name: ç”Ÿæˆå®‰å“é¡¹ç›®ä»£ç +é…ç½®æ–‡ä»¶
        run: |
          # åˆå§‹åŒ–é¡¹ç›®è·¯å¾„
          PROJECT_PATH="/home/runner/work/webview-app/webview-app/myapp"
          ANDROID_ROOT="$PROJECT_PATH/android-project"
          APP_DIR="$ANDROID_ROOT/app"
          CORDOVA_LIB_DIR="$ANDROID_ROOT/CordovaLib"
          WWW_DIR="$APP_DIR/src/main/assets/www"
          
          # åˆ›å»ºé¡¹ç›®ç›®å½•ï¼ˆæŒ‰åŒ…åæ‹†åˆ†Javaç›®å½•ï¼Œå¦‚com.xxx.yyy â†’ com/xxx/yyyï¼‰
          JAVA_DIR="$APP_DIR/src/main/java/$(echo ${{ env.APP_PACKAGE }} | tr '.' '/')"
          mkdir -p "$JAVA_DIR" "$WWW_DIR" "$CORDOVA_LIB_DIR/src/main/java/org/apache/cordova"

          # -------------------------- 1. ç”ŸæˆWebViewæ ¸å¿ƒä»£ç  --------------------------
          cat > "$CORDOVA_LIB_DIR/src/main/java/org/apache/cordova/CordovaActivity.java" << EOF
          package org.apache.cordova;
          import android.app.Activity;
          import android.os.Bundle;
          import android.webkit.SslErrorHandler;
          import android.webkit.WebChromeClient;
          import android.webkit.WebResourceRequest;
          import android.webkit.WebSettings;
          import android.webkit.WebView;
          import android.webkit.WebViewClient;
          import android.net.http.SslError;
          import android.widget.Toast;

          public class CordovaActivity extends Activity {
              private WebView webView;
              private static final int LOAD_TIMEOUT = ${{ env.LOAD_TIMEOUT }}; // ä»Žconfig.xmlè¯»å–è¶…æ—¶æ—¶é—´

              @Override
              protected void onCreate(Bundle savedInstanceState) {
                  super.onCreate(savedInstanceState);
                  webView = new WebView(this);
                  WebSettings webSettings = webView.getSettings();

                  // åŸºç¡€é…ç½®ï¼ˆæ”¯æŒJSã€è·¨åŸŸã€ç¼©æ”¾ï¼‰
                  webSettings.setJavaScriptEnabled(true);
                  webSettings.setDomStorageEnabled(true);
                  webSettings.setAllowFileAccess(true);
                  webSettings.setAllowContentAccess(true);
                  webSettings.setSupportZoom(true);
                  webSettings.setBuiltInZoomControls(true);
                  webSettings.setDisplayZoomControls(false);
                  webSettings.setLoadWithOverviewMode(true);
                  webSettings.setUseWideViewPort(true);

                  // å…è®¸æ··åˆå†…å®¹ï¼ˆHTTPèµ„æºåœ¨HTTPSé¡µé¢åŠ è½½ï¼‰
                  if (android.os.Build.VERSION.SDK_INT >= android.os
